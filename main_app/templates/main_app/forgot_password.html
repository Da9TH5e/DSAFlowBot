{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forgot Password - DSAFlowBot</title>
  <link rel="stylesheet" href="{% static 'main_app/css/forgot_password.css' %}">
</head>
<body>
  <div class="utilies">
    <a href="/login/">Back</a>
  </div>

  <div class="login-box">
    <div class="login-container">
      <h1>Reset Password</h1>

      {% if messages %}
        {% for message in messages %}
          <div class="{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <form method="post" id="forgot-form">
        {% csrf_token %}
        
        <div class="form-group email-row">
          <label for="email">Email</label>
          <div class="email-input-group">
            <input type="email" name="email" id="email" value="{{ email|default:'' }}" required>
            <button type="button" id="send-otp-btn" class="secondary-btn">Send OTP</button>
          </div>
        </div>

        <div class="form-group otp-row">
          <label for="otp">One Time Password</label>
          <div class="otp-input-group">
            <input type="text" name="otp" id="otp" maxlength="6" pattern="\d{6}">
            <button type="button" id="verify-otp-btn" class="secondary-btn">Verify</button>
          </div>
        </div>

        <div class="form-group">
          <label for="new_password">New Password</label>
          <input type="password" name="new_password" id="new_password" required>
        </div>

        <div class="form-group">
          <label for="confirm_password">Confirm Password</label>
          <input type="password" name="confirm_password" id="confirm_password" required>
        </div>

        <button type="submit" id="reset-btn">Reset Password</button>
      </form>
    </div>
  </div>

    <script>
document.addEventListener("DOMContentLoaded", () => {
  const sendBtn = document.getElementById("send-otp-btn");
  const verifyBtn = document.getElementById("verify-otp-btn");
  const emailField = document.getElementById("email");
  const otpField = document.getElementById("otp");
  const otpRow = document.querySelector(".otp-row");
  const newPass = document.getElementById("new_password");
  const confirmPass = document.getElementById("confirm_password");
  const resetBtn = document.getElementById("reset-btn");
  const form = document.getElementById("forgot-form");

  const emailGroup = document.querySelector(".email-input-group");
  let timerText = document.createElement("p");
  timerText.style.color = "#ddd";
  timerText.style.fontSize = "0.8rem";
  timerText.style.marginTop = "10px";
  timerText.style.fontWeight = "400";
  timerText.style.opacity = "0";
  timerText.style.transition = "opacity 0.5s ease";
  emailGroup.parentElement.appendChild(timerText);

  function setButtonState(button, disabled) {
    button.style.transition = "all 0.3s ease";
    if (disabled) {
      button.disabled = true;
      button.style.backgroundColor = "#444";
      button.style.outline = "none";
      button.style.cursor = "not-allowed";
      button.style.opacity = "0.6";
    } else {
      button.disabled = false;
      button.style.backgroundColor = "#004450";
      button.style.outline = "1px solid #006172";
      button.style.cursor = "pointer";
      button.style.opacity = "1";
    }
  }

  function attachHover(button) {
    button.addEventListener("mouseover", () => {
      if (!button.disabled) {
        button.style.backgroundColor = "#005564";
        button.style.outline = "1px solid #00869e";
      }
    });
    button.addEventListener("mouseout", () => {
      if (!button.disabled) {
        button.style.backgroundColor = "#004450";
        button.style.outline = "1px solid #006172";
      }
    });
  }

  // Attach hover to all three buttons
  [sendBtn, verifyBtn, resetBtn].forEach(attachHover);

  // --- Timer ---
  function startTimer(seconds = 120) {
    setButtonState(sendBtn, true);
    timerText.style.opacity = "1";

    let remaining = seconds;
    const interval = setInterval(() => {
      const mins = Math.floor(remaining / 60);
      const secs = remaining % 60;
      timerText.textContent = `Resend available in ${mins}:${secs
        .toString()
        .padStart(2, "0")}`;
      remaining--;

      if (remaining < 0) {
        clearInterval(interval);
        timerText.textContent = "You can resend the code now";

        setTimeout(() => {
          timerText.style.opacity = "0";
          setTimeout(() => (timerText.textContent = ""), 500);
        }, 3000);

        setButtonState(sendBtn, false);
      }
    }, 1000);
  }

  function showPopup(message, type = "info") {
    const popup = document.createElement("div");
    popup.className = `popup ${type}`;
    popup.textContent = message;
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 3000);
  }

  // === STEP 1: SEND OTP ===
  sendBtn.addEventListener("click", () => {
    const email = emailField.value.trim();
    if (!email) return showPopup("Email is required", "error");

    setButtonState(sendBtn, true);

    fetch("/forgot_password/send_otp/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
      },
      body: JSON.stringify({ email }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.status === "ok") {
          showPopup(data.message, "success");
          otpRow.style.display = "block";
          startTimer(120);
        } else {
          showPopup(data.message, "error");
          setButtonState(sendBtn, false);
        }
      })
      .catch(() => {
        showPopup("Error sending OTP.", "error");
        setButtonState(sendBtn, false);
      });
  });

  // === STEP 2: VERIFY OTP ===
  verifyBtn.addEventListener("click", () => {
    const email = emailField.value.trim();
    const otp = otpField.value.trim();
    if (!otp) return showPopup("Please enter your code", "error");

    setButtonState(verifyBtn, true);

    fetch("/forgot_password/verify_otp/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
      },
      body: JSON.stringify({ email, otp }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.status === "ok") {
          showPopup("Email verified", "success");

          emailField.disabled = true;
          emailField.style.backgroundColor = "#333";
          emailField.style.cursor = "not-allowed";
          emailField.style.opacity = "0.7";

          otpRow.style.transition = "opacity 0.5s ease";
          otpRow.style.opacity = "0";
          sendBtn.style.transition = "opacity 0.5s ease";
          sendBtn.style.opacity = "0";
          timerText.style.transition = "opacity 0.5s ease";
          timerText.style.opacity = "0";

          setTimeout(() => {
            otpRow.style.display = "none";
            sendBtn.style.display = "none";
            timerText.style.display = "none";

            newPass.parentElement.style.display = "block";
            confirmPass.parentElement.style.display = "block";
            resetBtn.style.display = "block";

            newPass.parentElement.style.opacity = "0";
            confirmPass.parentElement.style.opacity = "0";
            resetBtn.style.opacity = "0";

            setTimeout(() => {
              newPass.parentElement.style.transition = "opacity 0.6s ease";
              confirmPass.parentElement.style.transition = "opacity 0.6s ease";
              resetBtn.style.transition = "opacity 0.6s ease";

              newPass.parentElement.style.opacity = "1";
              confirmPass.parentElement.style.opacity = "1";
              resetBtn.style.opacity = "1";
            }, 100);
          }, 600);
        } else {
          showPopup(data.message, "error");
        }
      })
      .catch(() => showPopup("Can't verify code", "error"))
      .finally(() => setButtonState(verifyBtn, false));
  });

  // === STEP 3: RESET PASSWORD ===
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const email = emailField.value.trim();
    const otp = otpField.value.trim();
    const new_password = newPass.value.trim();
    const confirm_password = confirmPass.value.trim();

    if (!new_password || !confirm_password)
      return showPopup("Both fields are required", "error");

    if (new_password !== confirm_password)
      return showPopup("Passwords do not match", "error");

    setButtonState(resetBtn, true);
    resetBtn.textContent = "Resetting";

    fetch("/forgot_password/verify_otp/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
      },
      body: JSON.stringify({ email, otp, new_password, confirm_password }),
    })
      .then((res) => res.json())
      .then((data) => {
        if (data.status === "ok") {
          showPopup("Password reset successfully", "success");
          setTimeout(() => (window.location.href = "/login/"), 2500);
        } else {
          showPopup(data.message, "error");
        }
      })
      .catch(() => showPopup("Error resetting password", "error"))
      .finally(() => {
        setButtonState(resetBtn, false);
        resetBtn.textContent = "Reset";
      });
  });

  // Initially hide password fields
  newPass.parentElement.style.display = "none";
  confirmPass.parentElement.style.display = "none";
  resetBtn.style.display = "none";
});
</script>
</body>
</html>
